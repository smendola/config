#!/bin/bash

export AC_DIFF_CLI=${AC_DIFF_CLI:-meld %1 %2}

LISTING="green"
CURRENT="yellow bold"
OOPS="red"
GOOD=green
#BANNER="reverse white bg-black dim"
BANNER=normal

source "${0%/*}/functions.sh"


while [[ $1 = -* ]]
do
    case $1 in
        (-c|--comment) shift; COMMENT=$1;;
        (*) fail "Unknown option: $1" ;;
    esac
    shift
done


ar () {
	accurev "$@"
}

run () {
	local f=$1; shift
	eval echo "$@"
}

mods () {
	local opt
	local els
	case "$1" in
		(-[ao]) opt=--outgoing
			shift ;;
		(-d) opt=-d
			shift ;;
		(*) opt=-m  ;;
	esac
	if [[ $# = 0 ]]
	then
		set .
	fi
	ar stat $opt -R -fl "${@}"
}

review () {
	local ans yn f=$1
	ar diff "$f" #2>/dev/null
	while true; do
		#echo "|"
		read -n1 -p ">> (k)eep, (R)evert, (s)kip, (r)eview, or (q)uit (k/R/s/r/q) [s]: " ans
		echo ""

		case ${ans} in
			(k)
			    if [[ -z $COMMENT ]]; then
			    	ar keep $f;
			    else
			    	ar keep -c "${COMMENT}" $f;
			    fi
			    break
			    ;;
			(R)
				#echo "|"
				read -n1 -p ">> Really revert ${f##*/}? (y/n) [n]: " yn
				echo ""

				if [[ $yn = y* ]]; then
					ar pop -O $f
					break
				fi
			    ;;
			(r|d)
				review "$f"
				break
				;;

			(s | "")
			    echo "Skipped."
			    return
			    ;;

			(q)
			    exit
			    ;;
		    (!*)
		        read ans
		    	run "$f" ${ans#}
		    	;;
			(*)
			    echo "$(style $OOPS)Huh?$(style normal)"
			    ;;
		esac
	done
}

main () {
	local f ans files=$(mods "$@")

	if [[ ! -z "$files" ]]; then
		echo -n $(style $BANNER)
		echo "$(style $BANNER)------------------------------------------------------$(style normal)"
		echo "$(style $BANNER)Reviewing:                                            $(style normal)"
		echo "$(style $BANNER)------------------------------------------------------$(style normal)"
		for f in $files; do echo "  - $(style $LISTING)${f}$(style normal)"; done
		echo ""

		for f in $files; do
			echo '------------------------------------------------------'
			echo "$(style $CURRENT)${f#/./}$(style normal)"
			echo '------------------------------------------------------'
			while true; do
				#echo "|"
				read -n1 -p ">> (r)eview, (s)kip, or (q)uit (r/s/q) [r]: " ans
				echo ""

				case ${ans} in
					(s)
					    echo "Skipped";
					    break
					    ;;
					(r|d|"")
					    review "$f";
					    break
					    ;;
					(q)
					    echo "Quit"
					    exit
					    ;;
					(*)
			    		echo "$(style $OOPS)Huh?$(style normal)"
					    ;;
				esac
			done
			echo ""
		done

		echo "$(style $GOOD)Finished.$(style normal)"
		echo "TODO: option to promote"
	else
		echo "No pending changes to review."
	fi
}

main "$@"
