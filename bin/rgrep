#!/bin/bash
unset GREP_OPTIONS
PS4='+\033[0;33m${BASH_SOURCE##*/}:${LINENO}:${FUNCNAME[0]}: \033[0;m'

exts=( )
if [[ $1 = -x ]]
then
    exts=( $(echo "$2" | tr , ' ') )
    shift 2
fi

if [[ $# < 1 ]]
then
    echo "Usage: rgrep [-x EXT[,EXT]]... [GREP_OPTS] SEARCH_RE"
    echo "Recursively grep files starting at ./"
    echo "looking for SEARCH_RE in all files encountered"
    echo "but ignoring CVS/GIT/AR metadata folders"
    echo "  -x EXT  only consider files with extension .EXT"
    echo "     multiple EXT's may be specifed, comma separated"
    echo "     the . may be omitted, i.e. -x java,properties"
    echo "     is equivalent to -x .java,.properties"
    echo "  GREP_OPTS passed directly to grep"
    echo ""
    exit 1
fi

re=${@:$#}
other_opts=("${@}")
unset other_opts[${#other_opts[@]}-1]

fixed_opts=( --recursive  --color=auto  --exclude-dir=.{git,csv,accurev} )

ext_opts=( )
for ext in ${exts[*]}
do
    ext_opts[${#ext_opts}]=--include="*.${ext#.}"
done

set -x
grep "${fixed_opts[@]}" "${ext_opts[@]}" "${other_opts[@]}" -e "${re}" .
