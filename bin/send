#!/bin/bash -e

# Usage:
#  send PATH ...
#  send mods
#  Can send mix of files and dirs
#  If PATH is exactly 'mods' it will instead send
#  files that are modified in git
# The output of this command includes the command
# to be used on the receiving end to receive the files.
# If possible, the command is also sent to the clipboard.


fname=send.$$.tar.xz
if [[ $1 == "mods" ]]
then
  declare -a mods=( $(git status -s -uno | sed -e 's/^.* //g') )
  exec send "${mods[@]}"
fi

read -sp "Passphrase for encryption, empty for unencrypted: " password
echo

# Check if the password is blank
if [[ -z "$password" ]];
then
  echo -e '\e[31mSending unencrypted\e[m'
  tar Jcf - "$@" | gpg --store -a -o "$fname"
else
  tar Jcf - "$@" |
  gpg --batch --passphrase-fd 3 -ac -o "$fname" 3<<<"$password"
fi

json=$(curl -F "file=@${fname}" https://file.io)
# echo "$json" | jq
rm -f $fname
link=$(echo "$json" | jq -r .link )
expires=$(echo "$json" | jq -r .expires )


if [[ -z $link ]]
then
  echo "$json" >&2
  exit 1
fi

receive_cmd="curl -s '$link' | gpg -d -o- | tar Jxfvv -"
echo -n -e '\e[32m'
echo "To receive the file, use the following command:"
echo -e '\e[m'
echo $receive_cmd
echo ""
(echo "$receive_cmd" | xsel -i -b 2>/dev/null && echo -e '\e[32m(Sent to clipboard)\e[m') || ( echo -e '\e[31m(No clipboard)\e[m' )

#echo "Expires: $expires"
