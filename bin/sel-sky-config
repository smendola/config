#!/bin/sh

trap "echo ABORTING; exit 1" ERR

function try_login()
{
    local msg=$( curl -s -u"$( base64 -d < ~/.skylogin )" https://cloud.skytap.com/configurations.xml |  xmlstarlet sel -t -m /error -v . -n  )
    if [[ $msg != "" ]]
    then
        echo "**$msg**"
        echo ""
        false
    fi
}

function get_login()
{
    echo "Enter your skytap credentials."
    echo "Most likely, your Skytap username is $USERNAME@phtcorp.com"
    read -p "Username: " username
    read -s -p "Password: " password
    echo ""
    echo ""
    echo $(echo -n "$username:$password" | base64) > ~/.skylogin
}

function login()
{
    if [[ ! -f ~/.skylogin ]]
    then
        get_login
    fi
    while ! try_login
    do
        get_login
    done
    
    CRED="$( base64 -d < ~/.skylogin)"
}

function usage()
{
    echo "${0##*/}: Select a Skytap configuration to use with SSH"
    echo ""
    echo "Usage: ${0##*/} [-l] [-n] [-u] [PATTERN]"
    echo "   -u  Use \$USERNAME-.* as a filter pattern"
    echo "   -l  Re-login"
    echo "   -n  Do not resume the configuration; default is to resume"
#    echo "   -s  SSH in after selecting the configuration"
#    echo "   -t  SSH in and set up tunneling after selecting the configuration"
    echo "   PATTERN  Only list configurations whose name match PATTERN "
    echo "            (case insensitive regexp)"
    exit
}

RESUME=1
while getopts hlnrstu OPTNAME
do
    case $OPTNAME in
     h|\?)
        usage;;
     l) LOGIN=1;;
     n) RESUME=0;;
     s) SSH=1; RESUME=1;;
     t) TUNNEL=1; RESUME=1;;
     r) echo "-r option is obsolete; resume is the default"
        usage;;
     u) USE_USERNAME=1;;
    esac
done
shift $(( $OPTIND - 1 ))

if [[ $LOGIN = 1 || ! -f ~/.skylogin ]]
then
    get_login
fi

login

pattern=""
if [[ $# == 0 ]]
then
    pattern=.*
else
    pattern=".*$1.*"
fi
if [[ $USE_USERNAME ]]
then
    pattern=${USERNAME}-.*${pattern}
fi

pattern="^[0-9]+ +${pattern}$"


echo "----------------------------------------------------"
echo "     id  name"
echo "----------------------------------------------------"
curl -s -u"${CRED}" https://cloud.skytap.com/configurations.xml |
xmlstarlet sel -t \
    -m '/configurations/configuration' \
    -v id -o ' ' -v name -n |
  grep -iE "$pattern" |
  sort -d -k2 |
  awk -- '{printf "%7d  %s\n", $1, gensub("^[0-9]+ +", "", "g", $0)}'

echo ""
echo -n "Select configuration id: "
read cfgid
if [[ $cfgid = '' ]]
then
    echo "OK, never mind."
    exit
fi

map=$(
    curl -s -u"${CRED}" https://cloud.skytap.com/configurations/$cfgid.xml |
    xmlstarlet sel -t \
        -m '/configuration/vms/vm' \
        -m 'interfaces/interface/services/service[id="22"]' \
        -v ../../hostname \
        -o '=' \
        -v external_port \
        -n
)

echo "-------------------------------------------------------"
echo $map
echo "-------------------------------------------------------"

cp ~/.ssh/config.tpl  ~/.ssh/config
for hp in $map
do
    host=${hp%=*}
    port=${hp#*=}
    sed --in-place -r 's/\{\{'${host}'\}\}/'$port'/g' ~/.ssh/config
done
chmod 700 ~/.ssh/config


if [[ $RESUME = 1 ]]
then
    echo -n 'Resuming configuration .'
    curl -s -X PUT -u"${CRED}" https://cloud.skytap.com/configurations/$cfgid.xml?runstate=running > /dev/null
    while [[ $runstate = '' || $runstate = 'busy' || $runstate = 'suspended' ]]
    do
        # Sometimes the first ?runstate command doesn't "take", keep sending it
        curl -s -X PUT -u"${CRED}" https://cloud.skytap.com/configurations/$cfgid.xml?runstate=running > /dev/null
        sleep 2
        echo -n . 
        runstate=$(curl -s -X PUT -u"${CRED}" https://cloud.skytap.com/configurations/$cfgid.xml |
            xmlstarlet sel -t \
                -m '/configuration/vms/vm[contains(name,"App Host 1")]' \
                -v runstate -n)
    done
    echo " $runstate"
fi

# if [[ $SSH ]]
# then
  # ssh skytap
# elif [[ $TUNNEL ]]
# then
  # ssh skytun
# fi
