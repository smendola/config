#!/bin/sh

trap "echo ABORTING; exit 1" ERR

function try_login()
{
    local msg=$( curl -s -u"$( base64 -d < ~/.skylogin )" https://cloud.skytap.com/configurations.xml |  xmlstarlet sel -t -m /error -v . -n  )
    if [[ $msg != "" ]]
    then
        echo "**$msg**"
        echo ""
        false
    fi
}

function get_login()
{
    echo "Enter your skytap credentials."
    echo "Remember the @phtcorp.com bit!"
    echo -n "Username: "; read username
    echo -n "Password: "; stty -echo; read password; stty echo; echo ""
    echo $(echo -n "$username:$password" | base64) > ~/.skylogin
}

function login()
{
    if [[ ! -f ~/.skylogin ]]
    then
        get_login
    fi
    while ! try_login
    do
        get_login
    done
}

function usage()
{
    echo "${0##*/}: select a Skytap configuration to use with SSH"
    echo "Usage: ${0##*/} [-l] [-r] [CONFIG_ID]"
    echo "   -l  Re-login"
    echo "   -r  Resume the configuration"
    echo "   CONFIG_ID  use this configuration instead of selecting from menu"
    exit
}


while getopts lr OPTNAME
do
    case $OPTNAME in
    \?) # Option not recognized
        usage;;
     h) usage;;
     l) LOGIN=1;;
     r) RESUME=1;;
    esac
done
shift $(( $OPTIND - 1 ))

if [[ $LOGIN = 1 || ! -f ~/.skylogin ]]
then
    get_login
fi

login

if [[ $# = 0 ]]
then
    echo ""
    curl -s -u"$( base64 -d < ~/.skylogin)" https://cloud.skytap.com/configurations.xml |
    xmlstarlet sel -t \
        -m '/configurations/configuration' \
        -v id -o ' ' -v name -n |
    sort -d -k2
    echo ""
    echo -n "Select configuration id: "
    read cfgid
    if [[ $cfgid = '' ]]
    then
        echo "OK, never mind."
        exit
    fi
else
    cfgid=$1
fi

port=$(
    curl -s -u"$( base64 -d < ~/.skylogin)" https://cloud.skytap.com/configurations/$cfgid.xml |
    xmlstarlet sel -t \
        -m '/configuration/vms/vm[name="CentOS 6.0 x64"]' \
        -m 'interfaces/interface/services/service[id="22"]' \
        -v external_port \
        -n
)
sed --in-place -r 's/^\t\t\t\tPort .*/\t\t\t\tPort '$port'/g' ~/.ssh/config
echo "Skytap SSH port number set to: $port"

if [[ $RESUME = 1 ]]
then
    echo -n 'Resuming configuration .'
    curl -s -X PUT -u"$( base64 -d < ~/.skylogin)" https://cloud.skytap.com/configurations/$cfgid.xml?runstate=running > /dev/null
    while [[ $runstate = '' || $runstate = 'busy' || $runstate = 'suspended' ]]
    do
        sleep 2
        echo -n .
        runstate=$(curl -s -X PUT -u"$( base64 -d < ~/.skylogin)" https://cloud.skytap.com/configurations/$cfgid.xml |
            xmlstarlet sel -t \
                -m '/configuration/vms/vm[name="CentOS 6.0 x64"]' \
                -v runstate -n)
    done
    echo " $runstate"
fi
